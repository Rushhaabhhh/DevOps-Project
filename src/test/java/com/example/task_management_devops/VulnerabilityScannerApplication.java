package com.example.task_management_devops;

import static org.hamcrest.Matchers.greaterThan;
import static org.hamcrest.Matchers.hasSize;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;

import com.example.task_management_devops.repository.ScanRepository;

/**
 * Comprehensive integration tests for Vulnerability Scanner API.
 */
@SpringBootTest
@AutoConfigureMockMvc
class VulnerabilityScannerApplicationTests {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ScanRepository scanRepository;

    @BeforeEach
    void setUp() {
        scanRepository.deleteAll();
    }

    @Test
    void contextLoads() {
        // Verifies Spring context loads successfully
    }

    @Test
    void shouldTriggerVulnerabilityScan() throws Exception {
        String scanRequest = """
            {
                "projectName": "test-project",
                "projectVersion": "1.0.0"
            }
            """;

        mockMvc.perform(post("/api/scans/trigger")
                .contentType(MediaType.APPLICATION_JSON)
                .content(scanRequest))
                .andExpect(status().isCreated())
                .andExpect(jsonPath("$.projectName").value("test-project"))
                .andExpect(jsonPath("$.projectVersion").value("1.0.0"))
                .andExpect(jsonPath("$.status").value("COMPLETED"))
                .andExpect(jsonPath("$.totalDependencies").value(greaterThan(0)))
                .andExpect(jsonPath("$.vulnerableDependencies").value(greaterThan(0)));
    }

    @Test
    void shouldRejectInvalidScanRequest() throws Exception {
        String invalidRequest = """
            {
                "projectName": "",
                "projectVersion": "1.0.0"
            }
            """;

        mockMvc.perform(post("/api/scans/trigger")
                .contentType(MediaType.APPLICATION_JSON)
                .content(invalidRequest))
                .andExpect(status().isBadRequest());
    }

    @Test
    void shouldGetAllScans() throws Exception {
        // Create a scan first
        String scanRequest = """
            {
                "projectName": "my-app",
                "projectVersion": "2.0.0"
            }
            """;

        mockMvc.perform(post("/api/scans/trigger")
                .contentType(MediaType.APPLICATION_JSON)
                .content(scanRequest))
                .andExpect(status().isCreated());

        // Now get all scans
        mockMvc.perform(get("/api/scans"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$", hasSize(greaterThan(0))))
                .andExpect(jsonPath("$[0].projectName").value("my-app"));
    }

    @Test
    void shouldGetScanById() throws Exception {
        // Create a scan
        String scanRequest = """
            {
                "projectName": "secure-app",
                "projectVersion": "1.5.0"
            }
            """;

        mockMvc.perform(post("/api/scans/trigger")
                .contentType(MediaType.APPLICATION_JSON)
                .content(scanRequest))
                .andExpect(status().isCreated());

        Long scanId = scanRepository.findAll().get(0).getId();

        // Get scan by ID
        mockMvc.perform(get("/api/scans/" + scanId))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.projectName").value("secure-app"))
                .andExpect(jsonPath("$.projectVersion").value("1.5.0"));
    }

    @Test
    void shouldReturnNotFoundForNonExistentScan() throws Exception {
        mockMvc.perform(get("/api/scans/99999"))
                .andExpect(status().isNotFound());
    }

    @Test
    void shouldGetVulnerabilitiesForScan() throws Exception {
        // Create a scan
        String scanRequest = """
            {
                "projectName": "vulnerable-app",
                "projectVersion": "1.0.0"
            }
            """;

        mockMvc.perform(post("/api/scans/trigger")
                .contentType(MediaType.APPLICATION_JSON)
                .content(scanRequest))
                .andExpect(status().isCreated());

        Long scanId = scanRepository.findAll().get(0).getId();

        // Get vulnerabilities
        mockMvc.perform(get("/api/scans/" + scanId + "/vulnerabilities"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$", hasSize(greaterThan(0))))
                .andExpect(jsonPath("$[0].cveId").exists())
                .andExpect(jsonPath("$[0].dependencyName").exists())
                .andExpect(jsonPath("$[0].severity").exists());
    }

    @Test
    void shouldGetProjectHistory() throws Exception {
        String projectName = "history-test";

        // Create multiple scans for same project
        for (int i = 1; i <= 3; i++) {
            String scanRequest = String.format("""
                {
                    "projectName": "%s",
                    "projectVersion": "1.0.%d"
                }
                """, projectName, i);

            mockMvc.perform(post("/api/scans/trigger")
                    .contentType(MediaType.APPLICATION_JSON)
                    .content(scanRequest))
                    .andExpect(status().isCreated());
        }

        // Get project history
        mockMvc.perform(get("/api/scans/project/" + projectName))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$", hasSize(3)))
                .andExpect(jsonPath("$[0].projectName").value(projectName));
    }

    @Test
    void shouldDeleteScan() throws Exception {
        // Create a scan
        String scanRequest = """
            {
                "projectName": "delete-test",
                "projectVersion": "1.0.0"
            }
            """;

        mockMvc.perform(post("/api/scans/trigger")
                .contentType(MediaType.APPLICATION_JSON)
                .content(scanRequest))
                .andExpect(status().isCreated());

        Long scanId = scanRepository.findAll().get(0).getId();

        // Delete the scan
        mockMvc.perform(delete("/api/scans/" + scanId))
                .andExpect(status().isNoContent());

        // Verify deletion
        mockMvc.perform(get("/api/scans/" + scanId))
                .andExpect(status().isNotFound());
    }

    @Test
    void shouldCheckScannerHealth() throws Exception {
        mockMvc.perform(get("/api/scans/health"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.status").value("UP"))
                .andExpect(jsonPath("$.message").exists())
                .andExpect(jsonPath("$.timestamp").exists());
    }

    @Test
    void shouldDetectCriticalVulnerabilities() throws Exception {
        String scanRequest = """
            {
                "projectName": "critical-test",
                "projectVersion": "1.0.0"
            }
            """;

        mockMvc.perform(post("/api/scans/trigger")
                .contentType(MediaType.APPLICATION_JSON)
                .content(scanRequest))
                .andExpect(status().isCreated())
                .andExpect(jsonPath("$.criticalCount").value(greaterThan(0)))
                .andExpect(jsonPath("$.riskLevel").value("CRITICAL"));
    }

    @Test
    void shouldTestActuatorHealthEndpoint() throws Exception {
        mockMvc.perform(get("/actuator/health"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.status").value("UP"));
    }
}